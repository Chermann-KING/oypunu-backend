/**
 * @fileoverview Gestionnaire d'erreurs applicatives refactorisÃ© pour O'Ypunu
 * 
 * Ce gestionnaire se concentre uniquement sur les erreurs de logique mÃ©tier
 * et d'application, dÃ©lÃ©guant les erreurs techniques de base de donnÃ©es au
 * DatabaseErrorHandler consolidÃ©. Il Ã©limine les duplications et fournit
 * une API claire pour les erreurs business-level.
 * 
 * @author Ã‰quipe O'Ypunu
 * @version 2.0.0 - RefactorisÃ© pour Ã©liminer duplications
 * @since 2025-01-01
 */

import { Injectable, Logger } from '@nestjs/common';
import { BaseErrorHandler } from '../core/base-error.handler';
import { ApplicationErrorCode } from '../core/error-codes.enum';
import { DatabaseErrorHandler } from './database-error.handler';

/**
 * Gestionnaire d'erreurs applicatives avec responsabilitÃ©s clarifiÃ©es
 * 
 * Cette classe Injectable se concentre exclusivement sur les erreurs de
 * logique mÃ©tier et d'application, sans duplication avec la gestion
 * technique de base de donnÃ©es. Elle hÃ©rite de BaseErrorHandler pour
 * les fonctionnalitÃ©s communes et dÃ©lÃ¨gue les erreurs DB au gestionnaire
 * spÃ©cialisÃ©.
 * 
 * ## ðŸŽ¯ ResponsabilitÃ©s spÃ©cifiques :
 * 
 * ### Erreurs d'authentification et autorisation
 * - Tokens manquants, invalides ou expirÃ©s
 * - Identifiants de connexion incorrects
 * - Permissions insuffisantes
 * 
 * ### Erreurs de validation applicative
 * - Validation de donnÃ©es mÃ©tier
 * - Champs requis spÃ©cifiques Ã  l'application
 * - Formats de donnÃ©es applicatifs
 * 
 * ### Erreurs de logique mÃ©tier
 * - RÃ¨gles business spÃ©cifiques (favoris, etc.)
 * - Ã‰tats d'objets mÃ©tier invalides
 * - Contraintes applicatives
 * 
 * ### Erreurs de ressources et accÃ¨s
 * - Ressources non trouvÃ©es
 * - Conflits de ressources
 * - ContrÃ´le d'accÃ¨s applicatif
 * 
 * @class ApplicationErrorHandler
 * @extends BaseErrorHandler
 * @version 2.0.0
 */
@Injectable()
export class ApplicationErrorHandler extends BaseErrorHandler {
  /** Logger spÃ©cialisÃ© pour les erreurs applicatives */
  protected readonly logger = new Logger(ApplicationErrorHandler.name);

  // ========== ERREURS D'AUTHENTIFICATION ==========

  /**
   * CrÃ©e une erreur d'authentification spÃ©cialisÃ©e
   * 
   * GÃ¨re tous les cas d'erreurs liÃ©s Ã  l'authentification avec
   * des messages utilisateur appropriÃ©s et un logging sÃ©curisÃ©.
   * 
   * @method createAuthError
   * @param {ApplicationErrorCode} code - Code d'erreur d'authentification
   * @param {string} [context] - Contexte de l'erreur (endpoint, service)
   * @param {any} [details] - DÃ©tails pour audit (pas de donnÃ©es sensibles)
   * @returns {HttpException} Exception d'authentification formatÃ©e
   * 
   * @example
   * ```typescript
   * throw this.applicationErrorHandler.createAuthError(
   *   ApplicationErrorCode.AUTH_TOKEN_EXPIRED,
   *   'AuthGuard.canActivate',
   *   { userId: user.id }
   * );
   * ```
   */
  createAuthError(
    code: ApplicationErrorCode.AUTH_TOKEN_MISSING | 
          ApplicationErrorCode.AUTH_TOKEN_INVALID | 
          ApplicationErrorCode.AUTH_TOKEN_EXPIRED | 
          ApplicationErrorCode.AUTH_CREDENTIALS_INVALID,
    context?: string,
    details?: any
  ) {
    const errorMessages = {
      [ApplicationErrorCode.AUTH_TOKEN_MISSING]: "Token d'authentification manquant",
      [ApplicationErrorCode.AUTH_TOKEN_INVALID]: "Token d'authentification invalide",
      [ApplicationErrorCode.AUTH_TOKEN_EXPIRED]: "Session expirÃ©e, veuillez vous reconnecter",
      [ApplicationErrorCode.AUTH_CREDENTIALS_INVALID]: "Identifiants invalides"
    };

    return this.createError(
      code,
      errorMessages[code],
      context,
      details
    );
  }

  // ========== ERREURS DE VALIDATION APPLICATIVE ==========

  /**
   * CrÃ©e une erreur de validation pour donnÃ©es applicatives
   * 
   * @method createValidationError
   * @param {string} message - Message de validation spÃ©cifique
   * @param {string} [context] - Contexte de validation
   * @param {any} [details] - DÃ©tails des champs en erreur
   * @returns {HttpException} Exception de validation
   */
  createValidationError(
    message: string,
    context?: string,
    details?: any
  ) {
    return this.createError(
      ApplicationErrorCode.VALIDATION_FAILED,
      message,
      context,
      details
    );
  }

  /**
   * CrÃ©e une erreur pour champ requis manquant
   * 
   * @method createRequiredFieldError
   * @param {string} fieldName - Nom du champ requis
   * @param {string} [context] - Contexte de validation
   * @returns {HttpException} Exception champ requis
   */
  createRequiredFieldError(
    fieldName: string,
    context?: string
  ) {
    return this.createError(
      ApplicationErrorCode.REQUIRED_FIELD_MISSING,
      `Le champ '${fieldName}' est requis`,
      context,
      { fieldName }
    );
  }

  // ========== ERREURS DE RESSOURCES ==========

  /**
   * CrÃ©e une erreur de ressource non trouvÃ©e
   * 
   * @method createNotFoundError
   * @param {string} resourceType - Type de ressource
   * @param {string} [resourceId] - ID de la ressource
   * @param {string} [context] - Contexte de recherche
   * @returns {HttpException} Exception ressource non trouvÃ©e
   */
  createNotFoundError(
    resourceType: string,
    resourceId?: string,
    context?: string
  ) {
    const message = resourceId 
      ? `${resourceType} avec l'ID '${resourceId}' non trouvÃ©`
      : `${resourceType} non trouvÃ©`;

    return this.createError(
      ApplicationErrorCode.RESOURCE_NOT_FOUND,
      message,
      context,
      { resourceType, resourceId }
    );
  }

  /**
   * CrÃ©e une erreur de conflit de ressource
   * 
   * @method createConflictError
   * @param {string} message - Message de conflit spÃ©cifique
   * @param {string} [context] - Contexte du conflit
   * @param {any} [details] - DÃ©tails du conflit
   * @returns {HttpException} Exception de conflit
   */
  createConflictError(
    message: string,
    context?: string,
    details?: any
  ) {
    return this.createError(
      ApplicationErrorCode.RESOURCE_ALREADY_EXISTS,
      message,
      context,
      details
    );
  }

  /**
   * CrÃ©e une erreur d'accÃ¨s refusÃ©
   * 
   * @method createForbiddenError
   * @param {string} [message] - Message d'accÃ¨s refusÃ© personnalisÃ©
   * @param {string} [context] - Contexte de l'accÃ¨s
   * @param {any} [details] - DÃ©tails pour audit
   * @returns {HttpException} Exception d'accÃ¨s refusÃ©
   */
  createForbiddenError(
    message: string = "AccÃ¨s refusÃ© Ã  cette ressource",
    context?: string,
    details?: any
  ) {
    return this.createError(
      ApplicationErrorCode.RESOURCE_ACCESS_DENIED,
      message,
      context,
      details
    );
  }

  /**
   * CrÃ©e une erreur de permissions insuffisantes
   * 
   * @method createInsufficientPermissionsError
   * @param {string} [requiredPermission] - Permission requise
   * @param {string} [context] - Contexte de vÃ©rification
   * @returns {HttpException} Exception permissions insuffisantes
   */
  createInsufficientPermissionsError(
    requiredPermission?: string,
    context?: string
  ) {
    const message = requiredPermission
      ? `Permission '${requiredPermission}' requise`
      : "Permissions insuffisantes pour cette opÃ©ration";

    return this.createError(
      ApplicationErrorCode.INSUFFICIENT_PERMISSIONS,
      message,
      context,
      { requiredPermission }
    );
  }

  // ========== ERREURS DE LOGIQUE MÃ‰TIER ==========

  /**
   * CrÃ©e une erreur de logique mÃ©tier pour les favoris
   * 
   * @method createFavoriteError
   * @param {boolean} isAlreadyInFavorites - Si dÃ©jÃ  en favoris
   * @param {string} wordId - ID du mot concernÃ©
   * @param {string} [context] - Contexte de l'opÃ©ration
   * @returns {HttpException} Exception favoris
   */
  createFavoriteError(
    isAlreadyInFavorites: boolean,
    wordId: string,
    context?: string
  ) {
    if (isAlreadyInFavorites) {
      return this.createError(
        ApplicationErrorCode.WORD_ALREADY_IN_FAVORITES,
        "Ce mot est dÃ©jÃ  dans vos favoris",
        context,
        { wordId }
      );
    } else {
      return this.createError(
        ApplicationErrorCode.WORD_NOT_IN_FAVORITES,
        "Ce mot n'est pas dans vos favoris",
        context,
        { wordId }
      );
    }
  }

  // ========== ERREURS DE SERVICES EXTERNES ==========

  /**
   * CrÃ©e une erreur de service externe
   * 
   * @method createExternalServiceError
   * @param {string} serviceName - Nom du service externe
   * @param {Error} originalError - Erreur originale
   * @param {string} [context] - Contexte de l'appel
   * @returns {HttpException} Exception service externe
   */
  createExternalServiceError(
    serviceName: string,
    originalError: Error,
    context?: string
  ) {
    this.logger.error(`External service error (${serviceName}):`, originalError.stack);
    
    return this.createError(
      ApplicationErrorCode.EXTERNAL_SERVICE_ERROR,
      `Service ${serviceName} temporairement indisponible`,
      context,
      { serviceName, originalMessage: originalError.message }
    );
  }

  // ========== DÃ‰LÃ‰GATION ERREURS BASE DE DONNÃ‰ES ==========

  /**
   * DÃ©lÃ¨gue la gestion des erreurs MongoDB au gestionnaire spÃ©cialisÃ©
   * 
   * Cette mÃ©thode redirige vers DatabaseErrorHandler pour Ã©viter
   * la duplication de code et centraliser la logique technique.
   * 
   * @method handleMongoError
   * @param {any} error - Erreur MongoDB
   * @param {string} operation - Nom de l'opÃ©ration
   * @param {string} [context] - Contexte applicatif
   * @throws {HttpException} Exception appropriÃ©e via DatabaseErrorHandler
   */
  handleMongoError(error: any, operation: string, context?: string): never {
    // DÃ©lÃ©guer au gestionnaire spÃ©cialisÃ© consolidÃ©
    throw DatabaseErrorHandler.handleDatabaseOperation(
      () => { throw error; },
      {
        operationName: operation,
        entityName: context || 'Resource'
      }
    );
  }

  /**
   * CrÃ©e une erreur d'ObjectId MongoDB invalide
   * 
   * @method createInvalidObjectIdError
   * @param {string} fieldName - Nom du champ avec ID invalide
   * @param {string} value - Valeur invalide fournie
   * @param {string} [context] - Contexte de validation
   * @returns {HttpException} Exception ObjectId invalide
   */
  createInvalidObjectIdError(
    fieldName: string,
    value: string,
    context?: string
  ) {
    return this.createError(
      ApplicationErrorCode.INVALID_OBJECT_ID,
      `Format d'ID invalide pour le champ '${fieldName}': '${value}'`,
      context,
      { fieldName, value }
    );
  }
}